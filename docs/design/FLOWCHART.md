# mrtrix-rish Pipeline Flowchart

## High-Level Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MRTRIX-RISH HARMONIZATION                           │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────┐
                    │         INPUT DATA              │
                    │  ┌───────────┐ ┌───────────┐   │
                    │  │  Site A   │ │  Site B   │   │
                    │  │(Reference)│ │ (Target)  │   │
                    │  │  DWI+Mask │ │  DWI+Mask │   │
                    │  └─────┬─────┘ └─────┬─────┘   │
                    └────────┼─────────────┼─────────┘
                             │             │
            ┌────────────────┘             └────────────────┐
            ▼                                              ▼
┌───────────────────────┐                    ┌───────────────────────┐
│   PHASE 1: TEMPLATE   │                    │   PHASE 2: HARMONIZE  │
│      CREATION         │                    │       TARGET          │
└───────────┬───────────┘                    └───────────┬───────────┘
            │                                            │
            ▼                                            ▼
    ┌───────────────┐                            ┌───────────────┐
    │  Registration │                            │  Registration │
    │  to Template  │                            │  to Template  │
    │    Space      │                            │    Space      │
    └───────┬───────┘                            └───────┬───────┘
            │                                            │
            ▼                                            ▼
    ┌───────────────┐                            ┌───────────────┐
    │    amp2sh     │                            │    amp2sh     │
    │  DWI → SH     │                            │  DWI → SH     │
    └───────┬───────┘                            └───────┬───────┘
            │                                            │
            ▼                                            ▼
    ┌───────────────┐                            ┌───────────────┐
    │ Extract RISH  │                            │ Extract RISH  │
    │   Features    │                            │   Features    │
    │  θ₀,θ₂,θ₄...  │                            │  θ₀,θ₂,θ₄...  │
    └───────┬───────┘                            └───────┬───────┘
            │                                            │
            ▼                                            │
    ┌───────────────┐                                    │
    │ Average RISH  │                                    │
    │  across Site  │                                    │
    │   A subjects  │                                    │
    └───────┬───────┘                                    │
            │                                            │
            ▼                                            ▼
    ┌───────────────┐                            ┌───────────────┐
    │   Template    │                            │    Compute    │
    │ θₗ_reference  │◀───────────────────────────│  Scale Maps   │
    └───────────────┘                            │ scale = θ_ref │
                                                 │       /θ_tar  │
                                                 └───────┬───────┘
                                                         │
                                                         ▼
                                                 ┌───────────────┐
                                                 │    Apply      │
                                                 │   Scaling     │
                                                 │  SH × scale   │
                                                 └───────┬───────┘
                                                         │
                                                         ▼
                                                 ┌───────────────┐
                                                 │   sh2amp      │
                                                 │  SH → DWI     │
                                                 │  (optional)   │
                                                 └───────┬───────┘
                                                         │
                                                         ▼
                                                 ┌───────────────┐
                                                 │  Harmonized   │
                                                 │    Output     │
                                                 └───────┬───────┘
                                                         │
                                                         ▼
                                                 ┌───────────────┐
                                                 │   QC Report   │
                                                 └───────────────┘
```

---

## Detailed: RISH Feature Extraction

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    RISH FEATURE EXTRACTION                                  │
└─────────────────────────────────────────────────────────────────────────────┘

INPUT: SH coefficients image (lmax=8 → 45 volumes)

┌───────────────────────────────────────────────────────────────────────────┐
│  SH Image (4D)                                                            │
│  ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐     │
│  │ V0  │ V1  │ V2  │ V3  │ V4  │ V5  │ V6  │ ... │ V27 │ ... │ V44 │     │
│  │l=0  │    l=2           │    l=4             │    l=6  │    l=8  │     │
│  │m=0  │m=-2  -1   0   1  2│m=-4 -3 -2 -1 0...4│  ...    │  ...    │     │
│  └──┬──┴─────┬─────────────┴───────┬───────────┴────┬────┴────┬────┘     │
└─────┼────────┼─────────────────────┼────────────────┼─────────┼──────────┘
      │        │                     │                │         │
      ▼        ▼                     ▼                ▼         ▼
  ┌───────┐ ┌──────────────────┐ ┌────────────┐ ┌─────────┐ ┌─────────┐
  │Extract│ │    Extract       │ │  Extract   │ │ Extract │ │ Extract │
  │ V[0]  │ │   V[1:6]         │ │  V[6:15]   │ │V[15:28] │ │V[28:45] │
  └───┬───┘ └────────┬─────────┘ └─────┬──────┘ └────┬────┘ └────┬────┘
      │              │                 │              │           │
      ▼              ▼                 ▼              ▼           ▼
  ┌───────┐  ┌─────────────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
  │  θ₀   │  │  Square each    │  │ Square  │  │ Square  │  │ Square  │
  │ =V[0] │  │  Sum over m     │  │ Sum     │  │ Sum     │  │ Sum     │
  └───┬───┘  │  √(Σ|c₂ₘ|²)     │  │ √(...)  │  │ √(...)  │  │ √(...)  │
      │      └────────┬────────┘  └────┬────┘  └────┬────┘  └────┬────┘
      │               │                │            │            │
      ▼               ▼                ▼            ▼            ▼
  ┌───────┐      ┌───────┐        ┌───────┐    ┌───────┐    ┌───────┐
  │  θ₀   │      │  θ₂   │        │  θ₄   │    │  θ₆   │    │  θ₈   │
  │ image │      │ image │        │ image │    │ image │    │ image │
  └───────┘      └───────┘        └───────┘    └───────┘    └───────┘

OUTPUT: 5 RISH feature images (for lmax=8)
```

---

## Detailed: Scale Map Computation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SCALE MAP COMPUTATION                                    │
└─────────────────────────────────────────────────────────────────────────────┘

For each SH order l ∈ {0, 2, 4, 6, 8}:

┌─────────────────────┐         ┌─────────────────────┐
│   θₗ_reference      │         │    θₗ_target        │
│   (template)        │         │    (subject)        │
└──────────┬──────────┘         └──────────┬──────────┘
           │                               │
           └───────────┬───────────────────┘
                       │
                       ▼
              ┌────────────────┐
              │    Division    │
              │ scale_l =      │
              │ θₗ_ref/θₗ_tar  │
              └────────┬───────┘
                       │
                       ▼
              ┌────────────────┐
              │   Handle NaN   │
              │  (mask low     │
              │   signal)      │
              └────────┬───────┘
                       │
                       ▼
              ┌────────────────┐
              │    Smooth      │
              │ (Gaussian      │
              │  FWHM=3mm)     │
              └────────┬───────┘
                       │
                       ▼
              ┌────────────────┐
              │  Clip Extreme  │
              │  [0.5, 2.0]    │
              └────────┬───────┘
                       │
                       ▼
              ┌────────────────┐
              │   scale_l      │
              │    image       │
              └────────────────┘
```

---

## Detailed: Apply Harmonization

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    APPLY HARMONIZATION                                      │
└─────────────────────────────────────────────────────────────────────────────┘

INPUT: Target SH image + Scale maps (per order)

┌───────────────────────────────────────────────────────────────────────────┐
│  Target SH Image                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ c₀₀ │ c₂₋₂ c₂₋₁ c₂₀ c₂₁ c₂₂ │ c₄₋₄ ... c₄₄ │ c₆... │ c₈... │     │ │
│  └──┬──┴──────────┬─────────────┴───────┬───────┴───┬───┴───┬───┘     │ │
└─────┼─────────────┼─────────────────────┼───────────┼───────┼─────────┘
      │             │                     │           │       │
      ▼             ▼                     ▼           ▼       ▼
  ┌───────┐    ┌────────────┐       ┌─────────┐  ┌───────┐ ┌───────┐
  │  ×    │    │     ×      │       │    ×    │  │   ×   │ │   ×   │
  │scale₀ │    │  scale₂    │       │ scale₄  │  │scale₆ │ │scale₈ │
  └───┬───┘    └─────┬──────┘       └────┬────┘  └───┬───┘ └───┬───┘
      │              │                   │           │         │
      ▼              ▼                   ▼           ▼         ▼
  ┌───────┐    ┌────────────┐       ┌─────────┐  ┌───────┐ ┌───────┐
  │c'₀₀   │    │c'₂₋₂...c'₂₂│       │c'₄...   │  │c'₆... │ │c'₈... │
  └───┬───┘    └─────┬──────┘       └────┬────┘  └───┬───┘ └───┬───┘
      │              │                   │           │         │
      └──────────────┴───────────────────┴───────────┴─────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │   Concatenate → Harmonized    │
                    │          SH Image             │
                    └───────────────────────────────┘
                                    │
                                    ▼ (optional)
                    ┌───────────────────────────────┐
                    │   sh2amp → Harmonized DWI     │
                    └───────────────────────────────┘
```

---

## QC Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    QC REPORT GENERATION                                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐
│  Original DWI   │    │ Harmonized DWI  │
└────────┬────────┘    └────────┬────────┘
         │                      │
         ▼                      ▼
┌─────────────────┐    ┌─────────────────┐
│  Compute DTI    │    │  Compute DTI    │
│  (FA, MD, etc.) │    │  (FA, MD, etc.) │
└────────┬────────┘    └────────┬────────┘
         │                      │
         └──────────┬───────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │   Compute Metrics   │
         │  • ΔFA, ΔMD         │
         │  • Angular corr.    │
         │  • Scale map stats  │
         └──────────┬──────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │  Generate Figures   │
         │  • Before/after     │
         │  • Scatter plots    │
         │  • Scale maps       │
         └──────────┬──────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │   HTML Report       │
         └─────────────────────┘
```

---

## MRtrix3 Commands Used

| Step | MRtrix3 Command | Purpose |
|------|-----------------|---------|
| DWI → SH | `amp2sh` | Convert DWI signal to SH coefficients |
| SH → DWI | `sh2amp` | Reconstruct DWI from SH |
| Extract volumes | `mrconvert -coord 3 X:Y` | Get specific SH order coefficients |
| Math operations | `mrcalc` | Square, multiply, divide, sqrt |
| Statistics | `mrmath` | Sum across axis |
| Smoothing | `mrfilter` | Gaussian smooth scale maps |
| Registration | `mrregister` | FOD-based registration |
| Template | `population_template` | Create population average |
| Mask | `dwi2mask` | Brain mask creation |
| Info | `mrinfo` | Get image metadata |
